---
import { getTranslation } from '../utils/i18n';

interface Props {
  locale?: 'es' | 'en';
}

const { locale = 'es' } = Astro.props;
const t = (key: string) => getTranslation(key, locale);
---

<section id="download" class="py-20 px-4 relative overflow-hidden">
  <!-- Background Elements - Reduced blur for performance -->
  <div class="absolute inset-0 bg-secondary/30 z-0"></div>
  <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none">
    <div class="absolute top-[-10%] right-[-5%] w-[400px] h-[400px] bg-primary/5 rounded-full blur-[60px]"></div>
    <div class="absolute bottom-[-10%] left-[-5%] w-[400px] h-[400px] bg-blue-600/5 rounded-full blur-[60px]"></div>
  </div>

  <div class="container mx-auto max-w-5xl relative z-10">
    <div class="bg-secondary/40 backdrop-blur-sm rounded-2xl p-8 md:p-12 border border-primary/20 shadow-glow relative overflow-hidden group hover:border-primary/40 transition-all duration-500">
      
      <!-- Decorative glow effect -->
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary to-transparent opacity-30 group-hover:opacity-80 transition-opacity duration-500"></div>
      
      <div class="flex flex-col md:flex-row items-center gap-8 md:gap-12">
        <!-- Text Content -->
        <div class="flex-1 text-center md:text-left">
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 border border-green-500/30 text-green-400 text-sm font-bold mb-4 animate-fade-up">
            <i class="fas fa-shield-alt"></i>
            <span data-i18n="open-source-badge">{t('open-source-badge')}</span>
          </div>
          
          <h2 class="text-3xl md:text-4xl font-bold text-primary mb-4 animate-fade-up animate-delay-100" data-i18n="download-section-title">
            {t('download-section-title')}
          </h2>
          <p class="text-lg text-white/80 mb-8 animate-fade-up animate-delay-200" data-i18n="download-section-desc">
            {t('download-section-desc')}
          </p>
          
          <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start animate-fade-up animate-delay-300">
            <!-- Direct Download Button -->
            <a 
              id="download-btn"
              href="https://github.com/LuminaKraft/LuminaKraftLauncher/releases/latest" 
              class="inline-flex items-center justify-center gap-3 px-8 py-4 rounded-xl bg-primary/90 text-white font-bold text-lg shadow-glow border border-primary/50 transition-all duration-300 hover:shadow-lg hover:bg-primary hover:border-primary hover:-translate-y-1 group/btn relative overflow-hidden"
            >
              <span class="absolute inset-0 bg-white/20 translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300"></span>
              <i id="download-icon" class="fas fa-download text-xl group-hover/btn:scale-110 transition-transform relative z-10"></i>
              <div class="flex flex-col items-start relative z-10">
                <span class="leading-none" data-i18n="download-button">{t('download-button')}</span>
                <span id="os-detect" class="text-xs opacity-70 font-normal mt-1" data-i18n="download-detecting">{t('download-detecting')}</span>
              </div>
            </a>

            <!-- GitHub Source Button -->
            <a 
              href="https://github.com/LuminaKraft/LuminaKraftLauncher" 
              target="_blank" 
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-3 px-8 py-4 rounded-xl bg-secondary/60 text-white font-bold text-lg border border-white/10 transition-all duration-300 hover:bg-secondary/80 hover:border-white/30 hover:-translate-y-1 group/git"
            >
              <i class="fab fa-github text-2xl group-hover/git:scale-110 transition-transform"></i>
              <span data-i18n="view-github-button">{t('view-github-button')}</span>
            </a>
          </div>
          
          <p class="text-sm text-white/50 mt-4 animate-fade-up animate-delay-400" data-i18n="download-version-info">
            <i class="fas fa-code-branch mr-1"></i> {t('download-version-info')}
          </p>
        </div>
        
        <!-- Visual/Icon -->
        <div class="w-full md:w-1/3 flex justify-center animate-fade-up animate-delay-200">
          <div class="relative w-48 h-48 md:w-64 md:h-64 flex items-center justify-center">
            <div class="absolute inset-0 bg-primary/10 rounded-full blur-xl animate-pulse"></div>
            <div class="relative z-10 bg-secondary/80 p-6 rounded-2xl border border-primary/30 shadow-lg transform rotate-3 hover:rotate-0 transition-transform duration-500 group-hover:scale-105">
              <img 
                src="/imgs/favicon.webp" 
                alt="LuminaKraft Launcher" 
                class="w-full h-full object-contain drop-shadow-[0_0_15px_rgba(74,144,226,0.5)]"
                loading="lazy"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { getTranslation, getUserLocale } from '../utils/i18n';

  document.addEventListener('DOMContentLoaded', async () => {
    const downloadBtn = document.getElementById('download-btn') as HTMLAnchorElement;
    const osDetect = document.getElementById('os-detect');
    const downloadIcon = document.getElementById('download-icon');
    const locale = getUserLocale();
    
    if (!downloadBtn || !osDetect) return;

    // Detect OS
    const platform = navigator.platform.toLowerCase();
    const userAgent = navigator.userAgent.toLowerCase();
    
    let os = 'unknown';
    let iconClass = 'fa-download';
    
    if (platform.includes('mac') || userAgent.includes('mac')) {
      os = 'macos';
      iconClass = 'fa-apple';
    } else if (platform.includes('win') || userAgent.includes('win')) {
      os = 'windows';
      iconClass = 'fa-windows';
    } else if (platform.includes('linux') || userAgent.includes('linux')) {
      os = 'linux';
      iconClass = 'fa-linux';
    }

    // Update UI with detected OS
    if (os !== 'unknown') {
      const osName = os === 'macos' ? 'macOS' : (os === 'windows' ? 'Windows' : 'Linux');
      const downloadFor = getTranslation('download-for', locale);
      osDetect.textContent = `${downloadFor} ${osName}`;
      
      if (downloadIcon) {
        downloadIcon.className = `fab ${iconClass} text-xl group-hover/btn:scale-110 transition-transform relative z-10`;
      }
    } else {
      osDetect.textContent = getTranslation('download-version-info', locale);
    }

    // Fetch latest release from GitHub API
    try {
      const response = await fetch('https://api.github.com/repos/LuminaKraft/LuminaKraftLauncher/releases/latest');
      if (response.ok) {
        const data = await response.json();
        const assets = data.assets;
        
        let downloadUrl = data.html_url; // Default to release page
        
        // Find appropriate asset based on OS
        if (os === 'windows') {
          const exeAsset = assets.find((a: any) => a.name.endsWith('.exe') || a.name.endsWith('.msi'));
          if (exeAsset) downloadUrl = exeAsset.browser_download_url;
        } else if (os === 'macos') {
          const dmgAsset = assets.find((a: any) => a.name.endsWith('.dmg') || a.name.endsWith('.app.tar.gz'));
          if (dmgAsset) downloadUrl = dmgAsset.browser_download_url;
        } else if (os === 'linux') {
          const debAsset = assets.find((a: any) => a.name.endsWith('.deb') || a.name.endsWith('.AppImage'));
          if (debAsset) downloadUrl = debAsset.browser_download_url;
        }
        
        downloadBtn.href = downloadUrl;
      }
    } catch (error) {
      console.error('Error fetching latest release:', error);
      // Fallback is already set to releases/latest
    }
  });
</script>
