---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getTranslation } from "../../utils/i18n";
import servers from "../../data/servers.json";
import type { GetStaticPaths } from "astro";

// Definimos el tipo para locale explícitamente
export type Locale = 'es' | 'en';

// Definir el tipo Server para evitar errores de TypeScript
export type Server = {
  id: string;
  name: string;
  slug: string;
  isNew: boolean;
  isActive: boolean;
  images: string[];
  logo: string;
  collaborators: { name: string; logo: string }[];
  versions: string[];
  modloader: string;
  gamemode: string;
  descriptionKey: string;
  leaderboardPath?: string;
};

// Asegurarnos de que servers sea tratado como un array de Server
const typedServers = servers as unknown as Server[];

// Función para analizar las cookies del lado del servidor
function getServerCookie(cookieString: string | null, name: string): string | null {
  if (!cookieString) return null;
  const cookies = cookieString.split(';');
  for (const cookie of cookies) {
    const [cookieName, cookieValue] = cookie.trim().split('=');
    if (cookieName === name) {
      return cookieValue;
    }
  }
  return null;
}

// Generar rutas dinámicas para ambos idiomas
export const getStaticPaths = (() => {
  // Generar rutas para cada servidor, tanto en español como en inglés
  return typedServers.flatMap((server: Server) => [
    {
      params: { slug: server.slug },
      props: { server, locale: 'es' as Locale }
    },
    {
      params: { slug: server.slug },
      props: { server, locale: 'en' as Locale }
    }
  ]);
}) satisfies GetStaticPaths;

// Obtener slug de la URL
const slugFromURL = Astro.params.slug;

// Obtener propiedades y cookies
const { server, locale: propLocale } = Astro.props as { server: Server, locale: Locale };

// Intentar encontrar el servidor manualmente si no está en props
const serverFromSlug: Server = server || typedServers.find(s => s.slug === slugFromURL) as Server;

// Si aún no tenemos el servidor, redireccionar a la página principal
if (!serverFromSlug) {
  return Astro.redirect('/');
}

// Obtener las cookies del encabezado de la solicitud
const cookieHeader = Astro.request.headers.get('cookie');

// Intentar obtener el idioma de la cookie
const languageCookie = getServerCookie(cookieHeader, 'selectedLanguage');

// Determinar el idioma final (priorizar cookie)
const locale: Locale = (languageCookie === 'en') ? 'en' : (propLocale || 'es');

// Traducir según el idioma
const t = (key: string) => getTranslation(key, locale);

// Título y descripción para SEO
const title = `${serverFromSlug.name} | LuminaKraft Studios`;
const description = t(serverFromSlug.descriptionKey);

// Determinar los colores específicos del servidor
let primaryColor = "#4a90e2"; // Color predeterminado
let secondaryColor = "#1a2735"; // Color secundario predeterminado

// Colores específicos por servidor
if (serverFromSlug.id === "onepieceworld") {
  primaryColor = "#ffb400";
  secondaryColor = "#1a2735";
} else if (serverFromSlug.id === "ancientkraft") {
  primaryColor = "#c0a080";
  secondaryColor = "#2a1f1f";
} else if (serverFromSlug.id === "pt-the_full_course") {
  primaryColor = "#ff5252";
  secondaryColor = "#2a2a2a";
}

// Definir video de YouTube si existe
const youtubeEmbed = {
  "onepieceworld": "https://www.youtube.com/embed/OadtwVyeRKI",
  "ancientkraft": "https://www.youtube.com/embed/SsBTE69AE8I",
  "pt-the_full_course": ""
}[serverFromSlug.id] || "";

// Características específicas por servidor
const serverFeatures = {
  "onepieceworld": [
    { icon: "fa-apple-whole", title: "Frutas del Diablo", description: "Consume poderosas frutas que te otorgarán habilidades especiales, ¡pero cuidado con el mar!" },
    { icon: "fa-fist-raised", title: "Combate con Haki y Estilos de Lucha", description: "Domina Haki, artes marciales y estilos de combate inspirados en personajes como Sanji o Zoro." },
    { icon: "fa-ship", title: "Explora el Grand Line", description: "Navega por islas legendarias, descubre tesoros y enfréntate a peligrosos piratas y marines." },
    { icon: "fa-users", title: "Aventuras Multijugador", description: "Únete a una tripulación, enfréntate a otros jugadores, o forma alianzas para dominar los mares." }
  ],
  "ancientkraft": [
    { icon: "fa-magic", title: "Sistema de Magia Personalizado", description: "Domina hechizos únicos y aprovecha el poder de los elementos" },
    { icon: "fa-fist-raised", title: "Combate Mejorado", description: "Experimenta batallas emocionantes con mecánicas y habilidades mejoradas" },
    { icon: "fa-map-marked-alt", title: "Vasto Mundo para Explorar", description: "Descubre ruinas antiguas, tesoros ocultos y mazmorras desafiantes" },
    { icon: "fa-users", title: "Aventuras Multijugador", description: "Forma equipo con amigos o únete a una facción para conquistar el mundo juntos" }
  ],
  "pt-the_full_course": [
    { icon: "fa-compass", title: "Exploración", description: "Descubre un mundo lleno de secretos y sorpresas por descubrir" },
    { icon: "fa-users", title: "Comunidad", description: "Únete a una comunidad amigable y colaborativa de jugadores" },
    { icon: "fa-puzzle-piece", title: "Plugins personalizados", description: "Disfruta de plugins exclusivos que mejoran la experiencia de juego" },
    { icon: "fa-calendar-alt", title: "Eventos regulares", description: "Participa en eventos especiales y competiciones organizadas por el staff" }
  ]
}[serverFromSlug.id] || [];

---

<BaseLayout title={title} description={description} locale={locale}>
  <!-- Estilos específicos del servidor -->
  <style define:vars={{ primaryColor, secondaryColor }}>
    .text-primary {
      color: var(--primaryColor);
    }
    .bg-primary {
      background-color: var(--primaryColor);
    }
    .hover\:bg-primary:hover {
      background-color: var(--primaryColor);
    }
    .from-primary {
      --tw-gradient-from: var(--primaryColor);
    }
    .to-primary {
      --tw-gradient-to: var(--primaryColor);
    }
    .border-primary {
      border-color: var(--primaryColor);
    }
    .shadow-glow {
      box-shadow: 0 0 15px rgba(var(--primaryColor), 0.5);
    }
    .bg-secondary {
      background-color: var(--secondaryColor);
    }
    
    /* Efectos de transición mejorados */
    .parallax-bg {
      position: relative;
      overflow: hidden;
    }
    
    .parallax-bg::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 50%, var(--primaryColor) 0%, transparent 70%);
      opacity: 0.1;
      z-index: -1;
      transform: translateZ(0);
      transition: opacity 0.5s ease;
    }
    
    .hero-glow {
      position: relative;
    }
    
    .hero-glow::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, var(--primaryColor) 0%, transparent 70%);
      opacity: 0.2;
      z-index: -1;
      filter: blur(40px);
      transition: all 0.5s ease;
    }
    
    .feature-card {
      transition: transform 0.5s ease, box-shadow 0.5s ease, border-color 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    
    .feature-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 100%);
      z-index: -1;
      transition: opacity 0.5s ease;
      opacity: 0;
    }
    
    .feature-card:hover::before {
      opacity: 1;
    }
    
    .feature-card:hover .feature-icon {
      transform: translateY(-10px);
    }
    
    .feature-icon {
      transition: transform 0.5s ease;
    }
    
    .screenshot-container {
      position: relative;
      overflow: hidden;
    }
    
    .screenshot-overlay {
      display: none;
    }
    
    .screenshot-container:hover img {
      transform: scale(1.1);
    }
    
    .join-button {
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      z-index: 1;
    }
    
    .join-button::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.7s ease;
      z-index: 0;
    }
    
    .join-button:hover::before {
      left: 100%;
    }
  </style>

  <!-- Aviso de servidor cerrado si aplica -->
  {!serverFromSlug.isActive && (
    <div class="fixed top-[60px] left-0 right-0 z-50 bg-red-500/80 text-white py-1 px-4 text-center font-medium text-sm flex items-center justify-center gap-2">
      <i class="fas fa-circle-exclamation"></i>
      <span>{t('server-closed')}</span>
    </div>
  )}

  <div class="pt-24 pb-16 px-4 parallax-bg">
    <div class="container mx-auto max-w-6xl">
      <!-- Cabecera del servidor -->
      <div class="flex flex-col items-center text-center mb-12 reveal-element">
        <div class="w-48 h-48 md:w-64 md:h-64 lg:w-80 lg:h-80 flex items-center justify-center mb-6 hero-glow">
          <img 
            src={serverFromSlug.logo || serverFromSlug.images[0]} 
            alt={`${serverFromSlug.name} Logo`}
            class="scale-125 max-w-full max-h-full object-contain transition-transform duration-700 hover:scale-135"
            loading="eager"
          />
        </div>
        <div>
          <div class="flex items-center justify-center flex-wrap gap-3 mb-2">
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-primary">{serverFromSlug.name}</h1>
            {serverFromSlug.isNew && (
              <span class="bg-primary/90 text-white px-3 py-1 rounded-full text-sm font-bold shine-effect">
                NEW
              </span>
            )}
          </div>
          <p class="text-white/90 text-lg md:text-xl max-w-2xl mx-auto mb-6">{t(serverFromSlug.descriptionKey)}</p>
          <div class="flex flex-wrap items-center justify-center gap-3">
            <span class="px-3 py-1 bg-black/30 backdrop-blur-sm rounded-full text-sm border border-primary/30 transition-all hover:border-primary/60 hover:bg-black/50 cursor-default">
              {serverFromSlug.gamemode}
            </span>
            <span class="px-3 py-1 bg-black/30 backdrop-blur-sm rounded-full text-sm border border-primary/30 transition-all hover:border-primary/60 hover:bg-black/50 cursor-default">
              {serverFromSlug.modloader}
            </span>
            {serverFromSlug.versions.map((version) => (
              <span class="px-3 py-1 bg-black/30 backdrop-blur-sm rounded-full text-sm border border-primary/30 transition-all hover:border-primary/60 hover:bg-black/50 cursor-default">
                {version}
              </span>
            ))}
          </div>
        </div>
      </div>

      <!-- Características del servidor -->
      {serverFeatures.length > 0 && (
        <div class="mb-12 reveal-element" data-reveal-delay="200">
          <h2 class="text-2xl font-bold text-primary mb-6">{t('features-title')}</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {serverFeatures.map((feature, index) => (
              <div class="feature-card bg-black/30 backdrop-blur-sm p-6 rounded-lg text-center border border-primary/10 hover:border-primary/30 hover:shadow-lg" data-reveal-delay={200 + 100 * index}>
                <div class="feature-icon w-16 h-16 bg-black/20 rounded-full flex items-center justify-center mb-4 mx-auto">
                  <i class={`fas ${feature.icon} text-3xl text-primary`}></i>
                </div>
                <h3 class="text-xl font-bold text-primary mb-2">{t(`server-feature-${serverFromSlug.id}-${serverFeatures.indexOf(feature) + 1}-title`)}</h3>
                <p class="text-white/80">{t(`server-feature-${serverFromSlug.id}-${serverFeatures.indexOf(feature) + 1}-desc`)}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Tráiler del servidor si existe -->
      {youtubeEmbed && (
        <div class="mb-12 reveal-element" data-reveal-delay="300">
          <h2 class="text-2xl font-bold text-primary mb-6">{t('trailers-title')} {serverFromSlug.name}</h2>
          <div class="relative overflow-hidden pt-[56.25%] rounded-lg border border-primary/20 transition-all hover:border-primary/40 hover:shadow-lg">
            <iframe 
              class="absolute top-0 left-0 w-full h-full border-0"
              src={youtubeEmbed}
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen
              loading="lazy"
            ></iframe>
          </div>
        </div>
      )}

      <!-- Imágenes del servidor -->
      <div class="mb-12 reveal-element" data-reveal-delay="400">
        <h2 class="text-2xl font-bold text-primary mb-6">{t('screenshots-title')}</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {serverFromSlug.images.map((image, index) => (
            <div class="screenshot-container rounded-lg border border-primary/20 overflow-hidden">
              <img 
                src={image} 
                alt={`${serverFromSlug.name} Screenshot ${index + 1}`}
                class="w-full h-64 object-cover transition-transform duration-700"
                width="800"
                height="450"
                loading={index === 0 ? "eager" : "lazy"}
              />
              <div class="screenshot-overlay"></div>
            </div>
          ))}
        </div>
      </div>

      <div class="text-center mb-16 reveal-element" data-reveal-delay="500">
        {serverFromSlug.isActive ? (
          <a 
            href="#join-server" 
            id="join-button"
            class="join-button inline-block px-8 py-4 rounded-full bg-primary/90 text-white font-bold text-lg shadow-glow border border-primary/50 transition-all hover:shadow-lg hover:bg-primary hover:border-primary hover:-translate-y-1 relative overflow-hidden"
          >
            <span class="relative z-10 flex items-center justify-center gap-2">
              <i class="fas fa-gamepad"></i>
              <span>{t('join-now')}</span>
            </span>
          </a>
        ) : (
          <div class="inline-block px-8 py-4 rounded-full bg-gray-700/90 text-white font-bold text-lg border border-gray-600/50 relative overflow-hidden opacity-80">
            <span class="flex items-center justify-center gap-2">
              <i class="fas fa-circle-xmark"></i>
              <span>{t('server-closed')}</span>
            </span>
          </div>
        )}
      </div>

      <!-- Instrucciones para unirse -->
      <div id="join-server" class="bg-black/30 backdrop-blur-md rounded-xl p-8 border border-primary/20 animate-fade-up animate-delay-400">
        <h2 class="text-2xl font-bold text-primary mb-6">{t('how-to-join-title')} {serverFromSlug.name}?</h2>
        
        <!-- Pasos para unirse -->
        <div class="flex flex-wrap justify-around mb-8">
          {serverFromSlug.modloader !== "Vanilla" ? (
            <>
              <div class="step text-center max-w-[250px] mb-8">
                <div class="step-number mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary mb-3">
                  <span class="text-2xl font-bold">1</span>
                </div>
                <h3 class="font-bold text-primary text-lg mb-2">{t('step1-title-modpack')}</h3>
                <p class="text-white/80">{t('step1-desc-modpack')}</p>
              </div>
              
              <div class="step text-center max-w-[250px] mb-8">
                <div class="step-number mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary mb-3">
                  <span class="text-2xl font-bold">2</span>
                </div>
                <h3 class="font-bold text-primary text-lg mb-2">{t('step2-title-modpack')}</h3>
                <p class="text-white/80">{t('step2-desc-modpack')}</p>
              </div>
              
              <div class="step text-center max-w-[250px] mb-8">
                <div class="step-number mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary mb-3">
                  <span class="text-2xl font-bold">3</span>
                </div>
                <h3 class="font-bold text-primary text-lg mb-2">{t('step3-title-modpack')}</h3>
                <p class="text-white/80">{t('step3-desc-modpack')} {serverFromSlug.name}!"</p>
              </div>
            </>
          ) : (
            <>
              <div class="step text-center max-w-[250px] mb-8">
                <div class="step-number mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary mb-3">
                  <span class="text-2xl font-bold">1</span>
                </div>
                <h3 class="font-bold text-primary text-lg mb-2">{t('step1-title-vanilla')}</h3>
                <p class="text-white/80">{t('step1-desc-vanilla')} {serverFromSlug.versions[0]}</p>
              </div>
              
              <div class="step text-center max-w-[250px] mb-8">
                <div class="step-number mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary mb-3">
                  <span class="text-2xl font-bold">2</span>
                </div>
                <h3 class="font-bold text-primary text-lg mb-2">{t('step2-title-vanilla')}</h3>
                <p class="text-white/80">{t('step2-desc-vanilla')}</p>
              </div>
              
              <div class="step text-center max-w-[250px] mb-8">
                <div class="step-number mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary mb-3">
                  <span class="text-2xl font-bold">3</span>
                </div>
                <h3 class="font-bold text-primary text-lg mb-2">{t('step3-title-vanilla')}</h3>
                <p class="text-white/80">{t('step3-desc-vanilla')}</p>
              </div>
            </>
          )}
        </div>
        
        <!-- Instrucciones según el tipo de servidor -->
        {serverFromSlug.modloader === "Vanilla" ? (
          <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-black/40 backdrop-blur-sm rounded-lg">
              <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary">
                <i class="fas fa-gamepad text-2xl"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold text-primary mb-1">{t('minecraft-version-title')}</h3>
                <p>{t('minecraft-version-desc')} {serverFromSlug.versions[0]}</p>
              </div>
            </div>
            
            <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-black/40 backdrop-blur-sm rounded-lg">
              <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary">
                <i class="fas fa-server text-2xl"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold text-primary mb-1">{t('server-address-title')}</h3>
                <p class="mb-2">{t('server-address-desc')}</p>
                <div class="flex">
                  <code class="bg-black/60 backdrop-blur-sm p-2 rounded border border-primary/30 font-mono select-all">
                    {serverFromSlug.id}.luminakraft.com
                  </code>
                  <button class="copy-button ml-2 px-3 bg-primary/20 hover:bg-primary/40 transition-colors rounded border border-primary/30" data-text={`${serverFromSlug.id}.luminakraft.com`}>
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-black/40 backdrop-blur-sm rounded-lg">
              <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary">
                <i class="fas fa-download text-2xl"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold text-primary mb-1">{t('modpack-install-title')}</h3>
                <p class="mb-2">{t('modpack-install-desc')}</p>
                <div class="flex flex-wrap gap-3">
                  {!serverFromSlug.isActive ? (
                    <span class="px-4 py-2 bg-gray-700/80 backdrop-blur-sm text-gray-300 rounded-lg">
                      <del>{t('download-installer')}</del>
                    </span>
                  ) : (
                    <a
                      href="#"
                      class="px-4 py-2 bg-primary/90 backdrop-blur-sm hover:bg-primary text-white rounded-lg transition-colors inline-flex items-center gap-2"
                    >
                      <i class="fas fa-download"></i>
                      <span>{t('download-installer')}</span>
                    </a>
                  )}
                </div>
              </div>
            </div>
            
            <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-black/40 backdrop-blur-sm rounded-lg">
              <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full bg-primary/20 text-primary">
                <i class="fas fa-info-circle text-2xl"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold text-primary mb-1">{t('auto-connect-title')}</h3>
                <p>{t('auto-connect-desc')} {serverFromSlug.name}!" {t('inside-game')}</p>
              </div>
            </div>
          </div>
        )}
        
        <!-- Botón Discord -->
        <div class="text-center mt-10">
          <a 
            href="https://discord.gg/UJZRrcUFMj"
            target="_blank"
            rel="noopener"
            class="inline-flex items-center gap-3 px-6 py-3 rounded-lg bg-[#5865F2]/80 backdrop-blur-sm hover:bg-[#5865F2] text-white font-bold transition-all duration-300 hover:shadow-lg hover:-translate-y-1"
          >
            <i class="fab fa-discord"></i>
            <span>{t('join-discord')}</span>
          </a>
        </div>
      </div>
      
      <!-- Sección de Leaderboard para servidores que lo tengan -->
      {serverFromSlug.leaderboardPath && (
        <div id="leaderboard-section" class="my-16 animate-fade-up animate-delay-500">
          <div class="bg-black/30 backdrop-blur-md rounded-xl p-8 border border-primary/20">
            <h2 class="text-2xl font-bold text-primary mb-6 flex items-center">
              <i class="fas fa-ranking-star mr-3"></i>
              {t('leaderboard-title')}
            </h2>
            <p class="text-white/80 mb-6">{t('leaderboard-description')}</p>
            
            <!-- Controles de paginación -->
            <div class="flex flex-wrap justify-between items-center mb-6">
              <div class="flex items-center space-x-2">
                <label for="playersPerPage" class="text-white/80 players-per-page-label">{t('leaderboard-player-per-page')}:</label>
                <select id="playersPerPage" class="bg-black/40 backdrop-blur-sm text-white border border-primary/30 rounded px-2 py-1">
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <div class="flex items-center space-x-2 mt-4 md:mt-0">
                <button id="prevPage" class="bg-black/40 backdrop-blur-sm text-white/80 border border-primary/30 rounded px-3 py-1 disabled:opacity-50 disabled:cursor-not-allowed">
                  <i class="fas fa-chevron-left mr-1"></i> {t('previous-page')}
                </button>
                <span id="pageIndicator" class="text-white/80">{t('server-detail-page')} 1 {t('server-detail-of')} 1</span>
                <button id="nextPage" class="bg-black/40 backdrop-blur-sm text-white/80 border border-primary/30 rounded px-3 py-1 disabled:opacity-50 disabled:cursor-not-allowed">
                  {t('next-page')} <i class="fas fa-chevron-right ml-1"></i>
                </button>
              </div>
            </div>
            
            <div id="leaderboard" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
              <!-- Se llenará dinámicamente con JavaScript -->
              <div class="flex justify-center items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
              </div>
            </div>
            
            <!-- Paginación inferior -->
            <div id="bottomPagination" class="flex justify-center mt-6">
              <div class="flex items-center space-x-2">
                <button id="prevPageBottom" class="bg-black/40 backdrop-blur-sm text-white/80 border border-primary/30 rounded px-3 py-1 disabled:opacity-50 disabled:cursor-not-allowed">
                  <i class="fas fa-chevron-left mr-1"></i> {t('previous-page')}
                </button>
                <span id="pageIndicatorBottom" class="text-white/80">{t('server-detail-page')} 1 {t('server-detail-of')} 1</span>
                <button id="nextPageBottom" class="bg-black/40 backdrop-blur-sm text-white/80 border border-primary/30 rounded px-3 py-1 disabled:opacity-50 disabled:cursor-not-allowed">
                  {t('next-page')} <i class="fas fa-chevron-right ml-1"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<script define:vars={{ 
  serverId: serverFromSlug.id, 
  leaderboardPath: serverFromSlug.leaderboardPath, 
  isActive: serverFromSlug.isActive,
  translations: {
    leaderboardError: t('leaderboard-error'),
    leaderboardNoData: t('leaderboard-no-data'),
    playerPerPage: locale === 'en' ? 'Players per page:' : 'Jugadores por página:',
    pageOf: locale === 'en' ? 'of' : 'de',
    page: locale === 'en' ? 'Page' : 'Página',
    previous: t('previous-page'),
    next: t('next-page')
  },
  locale
}}>
  // Controlador para el efecto de revelar elementos al hacer scroll
  document.addEventListener('DOMContentLoaded', function() {
    // Revelar elementos al hacer scroll
    const revealElements = document.querySelectorAll('.reveal-element');
    
    const revealOnScroll = () => {
      const windowHeight = window.innerHeight;
      const scrollY = window.scrollY;
      
      revealElements.forEach(el => {
        const elementTop = el.getBoundingClientRect().top + scrollY;
        const elementVisible = 150;
        
        if (scrollY > elementTop - windowHeight + elementVisible) {
          const delay = el.getAttribute('data-reveal-delay') || 0;
          setTimeout(() => {
            el.classList.add('revealed');
          }, delay);
        }
      });
    };
    
    // Ejecutar al cargar la página para los elementos visibles inicialmente
    revealOnScroll();
    
    // Añadir listener para el scroll
    window.addEventListener('scroll', revealOnScroll);
    
    // Copiar al portapapeles
    const copyButtons = document.querySelectorAll('.copy-button');
    
    copyButtons.forEach(button => {
      button.addEventListener('click', function() {
        const text = button.dataset.text || '';
        navigator.clipboard.writeText(text).then(() => {
          // Cambiar ícono temporalmente
          const icon = button.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-check';
            setTimeout(() => {
              icon.className = 'fas fa-copy';
            }, 2000);
          }
        });
      });
    });
    
    // Cargar leaderboard si existe
    if (leaderboardPath) {
      loadLeaderboard();
    }
  });
  
  // Variables para paginación
  let leaderboardData = [];
  let currentPage = 1;
  let playersPerPage = 25;
  let totalPages = 1;
  
  // Función para cargar el leaderboard
  function loadLeaderboard() {
    console.log("Intentando cargar leaderboard desde:", leaderboardPath);
    fetch(leaderboardPath)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error al cargar el leaderboard: ${response.status} ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("Datos del leaderboard cargados:", data);
        leaderboardData = data.Sheet1 || [];
        
        if (!leaderboardData || leaderboardData.length === 0) {
          const leaderboardElement = document.getElementById('leaderboard');
          if (leaderboardElement) {
            leaderboardElement.innerHTML = `<div class="col-span-full text-center p-4 text-gray-400"><i class="fas fa-info-circle mr-2"></i>${translations.leaderboardNoData}</div>`;
          }
          return;
        }
        
        // Asegurar que la cantidad de jugadores por página sea múltiplo de 5
        adjustPlayersPerPage();
        
        totalPages = Math.ceil(leaderboardData.length / playersPerPage);
        
        // Inicializar paginación
        updatePageIndicators();
        updatePaginationButtons();
        renderLeaderboardPage();
        
        // Mostrar controles de paginación inferior si hay más de una página
        if (totalPages > 1) {
          document.getElementById('bottomPagination').classList.remove('hidden');
        }
        
        // Configurar eventos para la paginación
        document.getElementById('prevPage').addEventListener('click', goToPreviousPage);
        document.getElementById('nextPage').addEventListener('click', goToNextPage);
        document.getElementById('prevPageBottom').addEventListener('click', goToPreviousPage);
        document.getElementById('nextPageBottom').addEventListener('click', goToNextPage);
        
        // Cambiar jugadores por página
        document.getElementById('playersPerPage').addEventListener('change', function() {
          playersPerPage = parseInt(this.value);
          // Asegurar que sea múltiplo de 5
          adjustPlayersPerPage();
          
          currentPage = 1;
          totalPages = Math.ceil(leaderboardData.length / playersPerPage);
          updatePageIndicators();
          updatePaginationButtons();
          renderLeaderboardPage();
          
          // Mostrar u ocultar paginación inferior
          if (totalPages > 1) {
            document.getElementById('bottomPagination').classList.remove('hidden');
          } else {
            document.getElementById('bottomPagination').classList.add('hidden');
          }
        });
      })
      .catch(error => {
        const leaderboardElement = document.getElementById('leaderboard');
        if (leaderboardElement) {
          leaderboardElement.innerHTML = `<div class="col-span-full text-center p-4 text-red-400"><i class="fas fa-exclamation-circle mr-2"></i>${translations.leaderboardError}</div>`;
        }
      });
  }
  
  // Función para ajustar el número de jugadores por página a un múltiplo de 5
  function adjustPlayersPerPage() {
    const columnsCount = window.innerWidth >= 1024 ? 5 : (window.innerWidth >= 768 ? 3 : (window.innerWidth >= 640 ? 2 : 1));
    
    // Si no es múltiplo de columnsCount, redondear al múltiplo más cercano
    if (playersPerPage % columnsCount !== 0) {
      playersPerPage = Math.ceil(playersPerPage / columnsCount) * columnsCount;
      
      // Actualizar el select
      const selectElement = document.getElementById('playersPerPage');
      if (selectElement) {
        // Crear nueva opción si no existe
        let optionExists = false;
        for (let i = 0; i < selectElement.options.length; i++) {
          if (parseInt(selectElement.options[i].value) === playersPerPage) {
            selectElement.options[i].selected = true;
            optionExists = true;
            break;
          }
        }
        
        if (!optionExists) {
          const option = document.createElement('option');
          option.value = playersPerPage;
          option.text = playersPerPage;
          option.selected = true;
          selectElement.add(option);
        }
      }
    }
  }
  
  // Funciones para la paginación
  function goToNextPage() {
    if (currentPage < totalPages) {
      currentPage++;
      updatePageIndicators();
      updatePaginationButtons();
      renderLeaderboardPage();
    }
  }
  
  function goToPreviousPage() {
    if (currentPage > 1) {
      currentPage--;
      updatePageIndicators();
      updatePaginationButtons();
      renderLeaderboardPage();
    }
  }
  
  function updatePageIndicators() {
    const pageIndicator = document.getElementById('pageIndicator');
    const pageIndicatorBottom = document.getElementById('pageIndicatorBottom');
    const pageText = `${translations.playerPerPage} ${currentPage} ${translations.pageOf} ${totalPages}`;
    
    if (pageIndicator) pageIndicator.textContent = pageText;
    if (pageIndicatorBottom) pageIndicatorBottom.textContent = pageText;
  }
  
  function updatePaginationButtons() {
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');
    const prevButtonBottom = document.getElementById('prevPageBottom');
    const nextButtonBottom = document.getElementById('nextPageBottom');
    
    if (prevButton) prevButton.disabled = currentPage === 1;
    if (nextButton) nextButton.disabled = currentPage === totalPages;
    if (prevButtonBottom) prevButtonBottom.disabled = currentPage === 1;
    if (nextButtonBottom) nextButtonBottom.disabled = currentPage === totalPages;
  }
  
  function renderLeaderboardPage() {
    try {
      const leaderboardElement = document.getElementById('leaderboard');
      if (!leaderboardElement) {
        console.error("Elemento leaderboard no encontrado");
        return;
      }
      
      if (!leaderboardData || leaderboardData.length === 0) {
        leaderboardElement.innerHTML = `<div class="col-span-full text-center p-4 text-gray-400"><i class="fas fa-info-circle mr-2"></i>${translations.leaderboardNoData}</div>`;
        return;
      }
      
      const start = (currentPage - 1) * playersPerPage;
      const end = Math.min(start + playersPerPage, leaderboardData.length);
      const playersToShow = leaderboardData.slice(start, end);
      
      console.log(`Renderizando página ${currentPage}, mostrando jugadores ${start}-${end} de ${leaderboardData.length}`);
      
      let html = '';
      
      playersToShow.forEach((player, index) => {
        try {
          const rank = start + index + 1;
          const nombre = player.Usuario || "Desconocido";
          const horas = player.Horas || "0";
          const killsJugadores = player["Kills (jugadores)"] || "0";
          
          html += `
            <div class="player-card bg-black/40 backdrop-blur-sm p-4 rounded-lg text-center border border-primary/10 hover:border-primary/30 transition-all hover:transform hover:scale-105 cursor-pointer" data-expanded="false">
              <div class="rank text-xl font-bold text-primary">#${rank}</div>
              <div class="name mt-2">
                <img src="https://mc-heads.net/avatar/${nombre}/64" alt="${nombre}" class="w-16 h-16 rounded-lg mx-auto shadow-md" loading="lazy">
                <p class="mt-2 font-medium">${nombre}</p>
              </div>
              <div class="stats flex justify-center gap-4 mt-2">
                <div class="hours text-primary">
                  <i class="fas fa-clock"></i> ${horas}h
                </div>
                <div class="kills text-primary">
                  <i class="fas fa-skull"></i> ${killsJugadores}
                </div>
              </div>
              <div class="player-details max-h-0 overflow-hidden opacity-0 transition-all duration-300 mt-0">
                <div class="border-t border-primary/20 my-3"></div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div><i class="fas fa-skull-crossbones text-red-400"></i> ${player.Muertes}</div>
                  <div><i class="fas fa-dragon text-green-400"></i> ${player["Kill (mobs)"]}</div>
                  <div><i class="fas fa-heart-broken text-red-400"></i> ${player["Daño Recibido"]}</div>
                  <div><i class="fas fa-fist-raised text-green-400"></i> ${player["Daño Causado"]}</div>
                  <div><i class="fas fa-walking text-blue-400"></i> ${player["Caminado (km)"]}km</div>
                  <div><i class="fas fa-person-swimming text-blue-400"></i> ${player["Nadado (km)"]}km</div>
                  <div colspan="2" class="text-center"><i class="fas fa-ship text-blue-400"></i> ${player["Barco (km)"]}km</div>
                </div>
              </div>
            </div>
          `;
        } catch (playerError) {
          console.error("Error procesando jugador:", playerError, player);
        }
      });
      
      leaderboardElement.innerHTML = html || `<div class="col-span-full text-center p-4 text-gray-400"><i class="fas fa-info-circle mr-2"></i>${translations.leaderboardNoData}</div>`;
      
      // Añadir eventos para expandir/colapsar detalles
      document.querySelectorAll('.player-card').forEach(card => {
        card.addEventListener('click', () => {
          const details = card.querySelector('.player-details');
          const isExpanded = card.getAttribute('data-expanded') === 'true';
          
          if (isExpanded) {
            // Colapsar
            details.classList.remove('max-h-60', 'opacity-100', 'mt-3');
            details.classList.add('max-h-0', 'opacity-0', 'mt-0');
            card.setAttribute('data-expanded', 'false');
          } else {
            // Expandir
            details.classList.remove('max-h-0', 'opacity-0', 'mt-0');
            details.classList.add('max-h-60', 'opacity-100', 'mt-3');
            card.setAttribute('data-expanded', 'true');
          }
        });
      });
      
      // Actualizar etiquetas de servidor en español/inglés
      document.querySelectorAll('.players-per-page-label').forEach(el => {
        el.textContent = locale === 'en' ? 'Players per page:' : 'Jugadores por página:';
      });
      
    } catch (error) {
      console.error("Error renderizando leaderboard:", error);
      const leaderboardElement = document.getElementById('leaderboard');
      if (leaderboardElement) {
        leaderboardElement.innerHTML = `<div class="col-span-full text-center p-4 text-red-400"><i class="fas fa-exclamation-circle mr-2"></i>${translations.leaderboardError}</div>`;
      }
    }
  }
</script>

<style>
  /* Estilos para los efectos de revelación */
  .reveal-element {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s ease, transform 0.8s ease;
  }
  
  .reveal-element.revealed {
    opacity: 1;
    transform: translateY(0);
  }
  
  /* Efecto de brillo para badges */
  .shine-effect {
    position: relative;
    overflow: hidden;
  }
  
  .shine-effect::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
    transform: rotate(25deg);
    animation: shine 3s infinite;
    pointer-events: none;
  }
  
  @keyframes shine {
    0% { transform: translateX(-100%) rotate(25deg); }
    100% { transform: translateX(100%) rotate(25deg); }
  }
  
  /* Utilidades adicionales */
  .hover\:scale-135:hover {
    transform: scale(1.35);
  }
</style>