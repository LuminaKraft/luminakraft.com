---
// Auth callback page for OAuth - sends tokens to launcher via HTTP POST
import { getTranslation, getUserLocale, updateTextsForLocale } from "../utils/i18n";

const locale = getUserLocale();
const t = (key: string) => getTranslation(key, locale);
---

<!DOCTYPE html>
<html lang={locale}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{t('auth-success-title')} - LuminaKraft</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
</head>
<body class="bg-secondary text-white font-kanit min-h-screen flex items-center justify-center p-4">
    
    <div class="w-full max-w-sm bg-[#0b2545] border border-white/10 rounded-xl shadow-2xl p-8 text-center">
        <div class="mb-6 flex justify-center">
            <div id="icon-container" class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center animate-pulse">
                <i id="status-icon" class="fas fa-circle-notch fa-spin text-2xl text-primary"></i>
            </div>
        </div>
        
        <h1 id="title" class="text-xl font-bold text-white mb-2" data-i18n="auth-processing">{t('auth-processing')}</h1>
        <p id="subtitle" class="text-white/60 text-sm mb-6" data-i18n="auth-wait-moment">{t('auth-wait-moment')}</p>

        <button id="closeButton" onclick="window.close()" class="hidden w-full py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors text-sm font-medium">
            <span data-i18n="auth-close-window">{t('auth-close-window')}</span>
        </button>
        
        <a href="/" id="homeButton" class="hidden w-full py-2 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors text-sm font-medium mt-2">
            <span data-i18n="auth-return-home">{t('auth-return-home')}</span>
        </a>
    </div>

    <script>
        import { updateTextsForLocale, getUserLocale, getTranslation } from "../utils/i18n";

        // Initialize i18n
        const userLocale = getUserLocale();
        if (userLocale) {
            updateTextsForLocale(userLocale);
        }

        const t = (key) => getTranslation(key, userLocale);

        const hash = window.location.hash;
        const query = new URLSearchParams(window.location.search);
        
        const titleEl = document.getElementById('title');
        const subtitleEl = document.getElementById('subtitle');
        const iconContainer = document.getElementById('icon-container');
        const statusIcon = document.getElementById('status-icon');
        const closeButton = document.getElementById('closeButton');
        const homeButton = document.getElementById('homeButton');

        const isLauncher = query.get('launcher') === 'true';
        const port = query.get('port');

        function setSuccess() {
            titleEl.textContent = t('auth-success-title');
            subtitleEl.textContent = t('auth-ready-launcher');
            
            iconContainer.classList.remove('bg-primary/20', 'animate-pulse');
            iconContainer.classList.add('bg-green-500/20');
            
            statusIcon.className = 'fas fa-check text-3xl text-green-500';
            
            closeButton.classList.remove('hidden');
            
            // Try to close automatically
            setTimeout(() => {
                window.close();
            }, 2000);
        }

        function setError(msg) {
            titleEl.textContent = t('auth-error-title');
            subtitleEl.textContent = msg;
            
            iconContainer.classList.remove('bg-primary/20', 'animate-pulse');
            iconContainer.classList.add('bg-red-500/20');
            
            statusIcon.className = 'fas fa-times text-3xl text-red-500';
            
            homeButton.classList.remove('hidden');
        }

        async function handleCallback() {
            // Extract tokens from URL hash
            const hashParams = new URLSearchParams(hash.substring(1));
            
            // Check for errors first
            const error = hashParams.get('error');
            const errorDescription = hashParams.get('error_description');
            
            if (error) {
                console.error('Auth error:', error, errorDescription);
                setError(errorDescription?.replace(/\+/g, ' ') || error);
                return;
            }

            const accessToken = hashParams.get('access_token');
            const refreshToken = hashParams.get('refresh_token');
            const providerToken = hashParams.get('provider_token');
            const providerRefreshToken = hashParams.get('provider_refresh_token');

            if (!accessToken || !refreshToken) {
                setError(t('auth-no-credentials'));
                return;
            }

            if (!isLauncher || !port) {
                // Not launcher mode, just redirect to home
                window.location.href = '/';
                return;
            }

            // Send tokens to launcher via HTTP POST
            try {
                const response = await fetch(`http://localhost:${port}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        refresh_token: refreshToken,
                        provider_token: providerToken,
                        provider_refresh_token: providerRefreshToken
                    })
                });

                if (response.ok) {
                    setSuccess();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Failed to send tokens to launcher:', error);
                setError(t('auth-launcher-connect-error'));
            }
        }

        // Run callback handler
        if (hash) {
            handleCallback();
        } else {
            setError(t('auth-invalid-link'));
        }
    </script>
</body>
</html>
