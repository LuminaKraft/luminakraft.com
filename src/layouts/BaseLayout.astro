---
import { getTranslation, getUserLocale, saveUserLocale, updateTextsForLocale } from '../utils/i18n';

interface Props {
  title?: string;
  description?: string;
  locale?: 'es' | 'en';
}

// Usar el locale proporcionado como prop (userLocale) 
// En producción con compilación estática, no podemos acceder a las cookies del servidor
// La selección del idioma ocurrirá en el cliente con JavaScript
const userLocale = Astro.props.locale || 'es';

// Este código solo se ejecuta en el servidor durante la construcción de la página
const { 
  title = userLocale === 'en' 
    ? 'LuminaKraft Studios | Innovative Minecraft Server Development'
    : 'LuminaKraft Studios | Desarrollo Innovador de Servidores Minecraft',
  description = userLocale === 'en'
    ? 'LuminaKraft Studios is an innovative minecraft server development company. Explore our exciting server releases and join our community!'
    : 'LuminaKraft Studios es una empresa innovadora de desarrollo de servidores de Minecraft. ¡Explora nuestros emocionantes servidores y únete a nuestra comunidad!',
  locale = userLocale
} = Astro.props;

// Forzar el idioma detectado 
const finalLocale = userLocale;

// Función de traducción simplificada - usar directamente del módulo i18n
const t = (key) => getTranslation(key, finalLocale);
---

<!DOCTYPE html>
<html lang={finalLocale} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#011a38" />
    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content="LuminaKraft, server development, minecraft server, game studio" />
    <meta name="author" content="LuminaKraft Studios" />
    <meta name="robots" content="index, follow" />
    
    <!-- DNS prefetch para recursos externos -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    <link rel="dns-prefetch" href="//mc-heads.net" />
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
    
    <!-- Preconexión a Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />
    
    <!-- Meta etiquetas OpenGraph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="https://www.luminakraft.com/imgs/luminakraft_studios.webp" />
    <meta property="og:url" content="https://www.luminakraft.com" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content="https://www.luminakraft.com/imgs/luminakraft_studios.webp" />
    <link rel="icon" href="/imgs/favicon.webp" type="image/webp" />
    <link rel="apple-touch-icon" href="/imgs/apple-touch-icon.webp" />
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body class="bg-secondary text-white font-kanit overflow-x-hidden min-h-screen flex flex-col">
    <header class="fixed top-0 left-0 w-full z-50 bg-secondary/70 backdrop-blur-sm transition-all duration-300 py-3">
      <div class="container mx-auto px-4">
        <nav class="flex justify-between items-center">
          <div class="flex items-center">
            <a href="/" class="transition-transform hover:scale-110">
              <img src="/imgs/favicon.webp" alt="LuminaKraft Studios Logo" class="w-12 h-12" width="48" height="48" loading="eager" />
            </a>
            <div class="language-selector ml-4">
              <select id="language-selector" class="bg-secondary/80 text-white border border-primary/50 rounded px-2 py-1 text-sm hover:border-primary transition-colors">
                <option value="es" selected={finalLocale === 'es'}>ES</option>
                <option value="en" selected={finalLocale === 'en'}>EN</option>
              </select>
            </div>
          </div>
          <div class="hidden md:flex space-x-6 nav-links">
            <a href="/#inicio" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full" data-i18n="inicio">{t('inicio')}</a>
            <a href="/#servidores" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full" data-i18n="servidores">{t('servidores')}</a>
            <a href="/#servicios" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full" data-i18n="servicios">{t('servicios')}</a>
            <a href="/#colaboradores" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full" data-i18n="colaboradores">{t('colaboradores')}</a>
            <a href="/#nosotros" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full" data-i18n="nosotros">{t('nosotros')}</a>
            <a href="/#donaciones" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full" data-i18n="donaciones">{t('donaciones')}</a>
            <a href="/#contacto" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full" data-i18n="contacto">{t('contacto')}</a>
            <a href="https://wiki.luminakraft.com" target="_blank" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">Wiki <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
          </div>
          <button class="md:hidden mobile-menu-button text-2xl text-white" id="mobileMenuBtn" aria-label="Abrir menú">☰</button>
        </nav>
      </div>
    </header>

    <div class="mobile-menu fixed top-0 left-0 w-full h-full bg-secondary/95 z-50 transform translate-x-full transition-transform duration-300 backdrop-blur-md flex flex-col justify-center items-center" id="mobileMenu">
      <span class="close-menu absolute top-6 right-6 text-4xl text-white cursor-pointer">&times;</span>
      <div class="flex flex-col space-y-6 text-center">
        <a href="/#inicio" class="text-xl text-white hover:text-primary transition-colors" data-i18n="inicio">{t('inicio')}</a>
        <a href="/#servidores" class="text-xl text-white hover:text-primary transition-colors" data-i18n="servidores">{t('servidores')}</a>
        <a href="/#servicios" class="text-xl text-white hover:text-primary transition-colors" data-i18n="servicios">{t('servicios')}</a>
        <a href="/#colaboradores" class="text-xl text-white hover:text-primary transition-colors" data-i18n="colaboradores">{t('colaboradores')}</a>
        <a href="/#nosotros" class="text-xl text-white hover:text-primary transition-colors" data-i18n="nosotros">{t('nosotros')}</a>
        <a href="/#donaciones" class="text-xl text-white hover:text-primary transition-colors" data-i18n="donaciones">{t('donaciones')}</a>
        <a href="/#contacto" class="text-xl text-white hover:text-primary transition-colors" data-i18n="contacto">{t('contacto')}</a>
        <a href="https://wiki.luminakraft.com" target="_blank" class="text-xl text-white hover:text-primary transition-colors">Wiki <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
      </div>
      <div class="mt-8">
        <label for="mobile-language-selector" class="text-white mr-2" data-i18n="select-language">{t('select-language')}</label>
        <select id="mobile-language-selector" class="bg-secondary/80 text-white border border-primary/50 rounded px-2 py-1">
          <option value="es" selected={finalLocale === 'es'}>Español</option>
          <option value="en" selected={finalLocale === 'en'}>English</option>
        </select>
      </div>
    </div>

    <main class="flex-grow">
      <slot />
    </main>

    <footer class="bg-secondary relative overflow-hidden py-12 mt-8">
      <div class="container mx-auto px-4">
        <div class="footer-content flex flex-col md:flex-row md:justify-between gap-8 max-w-5xl mx-auto">
          <div class="footer-section text-center">
            <h3 class="text-xl font-bold mb-4 text-primary relative pb-2 inline-block" data-i18n="quick-links">{t('quick-links')}</h3>
            <ul class="space-y-2">
              <li><a href="/#inicio" class="text-white hover:text-primary transition-colors" data-i18n="inicio">{t('inicio')}</a></li>
              <li><a href="/#servidores" class="text-white hover:text-primary transition-colors" data-i18n="servidores">{t('servidores')}</a></li>
              <li><a href="/#servicios" class="text-white hover:text-primary transition-colors" data-i18n="servicios">{t('servicios')}</a></li>
              <li><a href="/#colaboradores" class="text-white hover:text-primary transition-colors" data-i18n="colaboradores">{t('colaboradores')}</a></li>
              <li><a href="/#nosotros" class="text-white hover:text-primary transition-colors" data-i18n="nosotros">{t('nosotros')}</a></li>
              <li><a href="/#donaciones" class="text-white hover:text-primary transition-colors" data-i18n="donaciones">{t('donaciones')}</a></li>
              <li><a href="/#contacto" class="text-white hover:text-primary transition-colors" data-i18n="contacto">{t('contacto')}</a></li>
              <li>
                <a href="https://wiki.luminakraft.com" target="_blank" class="text-white hover:text-primary transition-colors">
                  Wiki <i class="fas fa-external-link-alt text-xs ml-1"></i>
                </a>
              </li>
            </ul>
          </div>
          <div class="footer-section text-center">
            <h3 class="text-xl font-bold mb-4 text-primary relative pb-2 inline-block" data-i18n="social-media">{t('social-media')}</h3>
            <div class="flex justify-center space-x-4">
              <a href="https://x.com/luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="X (Twitter)">
                <i class="fab fa-x-twitter"></i>
              </a>
              <a href="https://instagram.com/luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="Instagram">
                <i class="fab fa-instagram"></i>
              </a>
              <a href="https://tiktok.com/@luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="TikTok">
                <i class="fab fa-tiktok"></i>
              </a>
              <a href="https://youtube.com/@luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="YouTube">
                <i class="fab fa-youtube"></i>
              </a>
              <a href="https://discord.gg/UJZRrcUFMj" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="Discord">
                <i class="fab fa-discord"></i>
              </a>
            </div>
          </div>
          <div class="footer-section text-center">
            <h3 class="text-xl font-bold mb-4 text-primary relative pb-2 inline-block" data-i18n="legal">{t('legal')}</h3>
            <ul class="space-y-2">
              <li><a href="/privacy" class="text-white hover:text-primary transition-colors" data-i18n="privacy-policy">{t('privacy-policy')}</a></li>
              <li><a href="/terms" class="text-white hover:text-primary transition-colors" data-i18n="terms-of-service">{t('terms-of-service')}</a></li>
            </ul>
          </div>
        </div>
        <div class="mt-12 text-center text-sm text-gray-400">
          <p>&copy; {new Date().getFullYear()} LuminaKraft Studios. <span data-i18n="all-rights-reserved">{t('all-rights-reserved')}</span></p>
        </div>
      </div>
    </footer>

    <script>
      import { getTranslation, saveUserLocale, updateTextsForLocale } from '../utils/i18n';
      
      document.addEventListener('DOMContentLoaded', function() {
        setupMobileMenu();
        setupLanguageSelectors();
        setupHeaderScroll();
        
        // Mobile menu functionality
        function setupMobileMenu() {
          const mobileMenuBtn = document.getElementById('mobileMenuBtn');
          const mobileMenu = document.getElementById('mobileMenu');
          const closeMenu = document.querySelector('.close-menu');
          const menuLinks = document.querySelectorAll('.mobile-menu a');
          
          if (mobileMenuBtn && mobileMenu && closeMenu) {
            mobileMenuBtn.addEventListener('click', function() {
              mobileMenu.classList.remove('translate-x-full');
              document.body.style.overflow = 'hidden';
            });
            
            closeMenu.addEventListener('click', function() {
              mobileMenu.classList.add('translate-x-full');
              document.body.style.overflow = '';
            });
            
            menuLinks.forEach(link => {
              link.addEventListener('click', function() {
                mobileMenu.classList.add('translate-x-full');
                document.body.style.overflow = '';
              });
            });
          }
        }
        
        // Language selector setup with client-side translation
        function setupLanguageSelectors() {
          const languageSelector = document.getElementById('language-selector') as HTMLSelectElement | null;
          const mobileLangSelector = document.getElementById('mobile-language-selector') as HTMLSelectElement | null;
          
          // Initialize selectors with stored language preference
          try {
            // Check for language in cookies
            const cookies = document.cookie.split(';');
            let storedLocale: 'en' | 'es' | null = null;
            
            for (const cookie of cookies) {
              const [name, value] = cookie.trim().split('=');
              if (name === 'selectedLanguage' && (value === 'en' || value === 'es')) {
                storedLocale = value as 'en' | 'es';
                break;
              }
            }
            
            if (storedLocale) {
              // Update selectors to match stored preference
              if (languageSelector) languageSelector.value = storedLocale;
              if (mobileLangSelector) mobileLangSelector.value = storedLocale;
              
              // Also update page content
              updateTextsForLocale(storedLocale as 'en' | 'es');
            }
          } catch (e) {
            console.warn('Error accessing cookies:', e);
          }
          
          if (languageSelector) {
            languageSelector.addEventListener('change', function(e) {
              const target = e.target as HTMLSelectElement;
              if (target && target.value) {
                changeLanguage(target.value as 'es' | 'en');
              }
            });
          }
          
          if (mobileLangSelector) {
            mobileLangSelector.addEventListener('change', function(e) {
              const target = e.target as HTMLSelectElement;
              if (target && target.value) {
                changeLanguage(target.value as 'es' | 'en');
              }
            });
          }
          
          // Handle language change without page reload
          function changeLanguage(locale: 'es' | 'en') {
            // Save the language preference
            saveUserLocale(locale);
            
            // Update all translatable elements on the page
            updateTextsForLocale(locale);
            
            // Update language selectors to reflect the change
            if (languageSelector) languageSelector.value = locale;
            if (mobileLangSelector) mobileLangSelector.value = locale;
          }
        }
        
        // Sticky header on scroll
        function setupHeaderScroll() {
          const header = document.querySelector('header');
          if (!header) return;
          
          window.addEventListener('scroll', function() {
            if (window.scrollY > 50) {
              header.classList.add('py-2', 'shadow-lg', 'bg-secondary/90');
              header.classList.remove('py-3', 'bg-secondary/70');
            } else {
              header.classList.remove('py-2', 'shadow-lg', 'bg-secondary/90');
              header.classList.add('py-3', 'bg-secondary/70');
            }
          });
        }
      });
    </script>
    
    <!-- Additional Scripts -->
    <slot name="scripts" />

    <script>
      // This script runs as soon as possible to set the language based on preferences
      // before the page fully loads to minimize language flickering
      (function() {
        try {
          // 1. Check for existing cookie first
          const cookies = document.cookie.split(';');
          let foundLanguage: 'en' | 'es' | null = null;
          
          for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'selectedLanguage' && (value === 'en' || value === 'es')) {
              foundLanguage = value as 'en' | 'es';
              break;
            }
          }
          
          // 2. If no cookie exists, detect browser language
          if (!foundLanguage) {
            const browserLang = navigator.language || (navigator as any).userLanguage;
            // Spanish language detection (es-ES, es-MX, es-AR, etc.)
            const isSpanish = browserLang.toLowerCase().startsWith('es');
            foundLanguage = isSpanish ? 'es' : 'en';
            
            // Save this detected preference in cookie
            document.cookie = `selectedLanguage=${foundLanguage}; max-age=31536000; path=/; SameSite=Strict`;
          }
          
          // Set html lang attribute
          if (foundLanguage) {
            document.documentElement.lang = foundLanguage;
          }
          
        } catch (e) {
          console.warn('Error in early language detection:', e);
        }
      })();
    </script>
  </body>
</html>
