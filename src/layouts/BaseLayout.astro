---
import { getTranslation, getUserLocale, saveUserLocale } from '../utils/i18n';

interface Props {
  title?: string;
  description?: string;
  locale?: 'es' | 'en';
}

// Función para analizar las cookies del lado del servidor
function getServerCookie(cookieString, name) {
  if (!cookieString) return null;
  const cookies = cookieString.split(';');
  for (const cookie of cookies) {
    const [cookieName, cookieValue] = cookie.trim().split('=');
    if (cookieName === name) {
      return cookieValue;
    }
  }
  return null;
}

// Obtener el idioma de la cookie
const cookieHeader = Astro.request.headers.get('cookie');
const languageCookie = getServerCookie(cookieHeader, 'selectedLanguage');

// Intentar obtener el idioma del usuario
const userLocale: 'es' | 'en' = (languageCookie === 'en') ? 'en' : 'es';

// Este código solo se ejecuta en el servidor durante la construcción de la página
const { 
  title = userLocale === 'en' 
    ? 'LuminaKraft Studios | Innovative Minecraft Server Development'
    : 'LuminaKraft Studios | Desarrollo Innovador de Servidores Minecraft',
  description = userLocale === 'en'
    ? 'LuminaKraft Studios is an innovative minecraft server development company. Explore our exciting server releases and join our community!'
    : 'LuminaKraft Studios es una empresa innovadora de desarrollo de servidores de Minecraft. ¡Explora nuestros emocionantes servidores y únete a nuestra comunidad!',
  locale = userLocale
} = Astro.props;

// Forzar el idioma detectado 
const finalLocale = userLocale;

// Función de traducción simplificada - usar directamente del módulo i18n
const t = (key) => getTranslation(key, finalLocale);
---

<!DOCTYPE html>
<html lang={finalLocale} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#011a38" />
    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content="LuminaKraft, server development, minecraft server, game studio" />
    <meta name="author" content="LuminaKraft Studios" />
    <meta name="robots" content="index, follow" />
    
    <!-- DNS prefetch para recursos externos -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    <link rel="dns-prefetch" href="//mc-heads.net" />
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
    
    <!-- Preconexión a Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />
    
    <!-- Meta etiquetas OpenGraph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="https://www.luminakraft.com/imgs/luminakraft_studios.webp" />
    <meta property="og:url" content="https://www.luminakraft.com" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content="https://www.luminakraft.com/imgs/luminakraft_studios.webp" />
    <link rel="icon" href="/imgs/favicon.webp" type="image/webp" />
    <link rel="apple-touch-icon" href="/imgs/apple-touch-icon.webp" />
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerPolicy="no-referrer" />
  </head>
  <body class="bg-secondary text-white font-kanit overflow-x-hidden min-h-screen flex flex-col">
    <header class="fixed top-0 left-0 w-full z-50 bg-secondary/70 backdrop-blur-sm transition-all duration-300 py-3">
      <div class="container mx-auto px-4">
        <nav class="flex justify-between items-center">
          <div class="flex items-center">
            <a href="/" class="transition-transform hover:scale-110">
              <img src="/imgs/favicon.webp" alt="LuminaKraft Studios Logo" class="w-12 h-12" width="48" height="48" loading="eager" />
            </a>
            <div class="language-selector ml-4">
              <select id="language-selector" class="bg-secondary/80 text-white border border-primary/50 rounded px-2 py-1 text-sm hover:border-primary transition-colors">
                <option value="es" selected={finalLocale === 'es'}>ES</option>
                <option value="en" selected={finalLocale === 'en'}>EN</option>
              </select>
            </div>
          </div>
          <div class="hidden md:flex space-x-6 nav-links">
            <a href="/#inicio" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">{t('inicio')}</a>
            <a href="/#servidores" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">{t('servidores')}</a>
            <a href="/#servicios" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">{t('servicios')}</a>
            <a href="/#colaboradores" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">{t('colaboradores')}</a>
            <a href="/#nosotros" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">{t('nosotros')}</a>
            <a href="/#donaciones" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">{t('donaciones')}</a>
            <a href="/#contacto" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">{t('contacto')}</a>
            <a href="https://wiki.luminakraft.com" target="_blank" class="nav-link relative text-white hover:text-primary transition-colors after:absolute after:bottom-0 after:left-0 after:w-0 after:h-0.5 after:bg-primary after:transition-all after:duration-300 hover:after:w-full">Wiki <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
          </div>
          <button class="md:hidden mobile-menu-button text-2xl text-white" id="mobileMenuBtn" aria-label="Abrir menú">☰</button>
        </nav>
      </div>
    </header>

    <div class="mobile-menu fixed top-0 left-0 w-full h-full bg-secondary/95 z-50 transform translate-x-full transition-transform duration-300 backdrop-blur-md flex flex-col justify-center items-center" id="mobileMenu">
      <span class="close-menu absolute top-6 right-6 text-4xl text-white cursor-pointer">&times;</span>
      <div class="flex flex-col space-y-6 text-center">
        <a href="/#inicio" class="text-xl text-white hover:text-primary transition-colors">{t('inicio')}</a>
        <a href="/#servidores" class="text-xl text-white hover:text-primary transition-colors">{t('servidores')}</a>
        <a href="/#servicios" class="text-xl text-white hover:text-primary transition-colors">{t('servicios')}</a>
        <a href="/#colaboradores" class="text-xl text-white hover:text-primary transition-colors">{t('colaboradores')}</a>
        <a href="/#nosotros" class="text-xl text-white hover:text-primary transition-colors">{t('nosotros')}</a>
        <a href="/#donaciones" class="text-xl text-white hover:text-primary transition-colors">{t('donaciones')}</a>
        <a href="/#contacto" class="text-xl text-white hover:text-primary transition-colors">{t('contacto')}</a>
        <a href="https://wiki.luminakraft.com" target="_blank" class="text-xl text-white hover:text-primary transition-colors">Wiki <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
      </div>
      <div class="mt-8">
        <label for="mobile-language-selector" class="text-white mr-2">{t('select-language')}</label>
        <select id="mobile-language-selector" class="bg-secondary/80 text-white border border-primary/50 rounded px-2 py-1">
          <option value="es" selected={finalLocale === 'es'}>Español</option>
          <option value="en" selected={finalLocale === 'en'}>English</option>
        </select>
      </div>
    </div>

    <main class="flex-grow">
      <slot />
    </main>

    <footer class="bg-secondary relative overflow-hidden py-12 mt-8">
      <div class="container mx-auto px-4">
        <div class="footer-content flex flex-col md:flex-row md:justify-between gap-8 max-w-5xl mx-auto">
          <div class="footer-section text-center">
            <h3 class="text-xl font-bold mb-4 text-primary relative pb-2 inline-block">{t('quick-links')}</h3>
            <ul class="space-y-2">
              <li><a href="/#inicio" class="text-white hover:text-primary transition-colors">{t('inicio')}</a></li>
              <li><a href="/#servidores" class="text-white hover:text-primary transition-colors">{t('servidores')}</a></li>
              <li><a href="/#servicios" class="text-white hover:text-primary transition-colors">{t('servicios')}</a></li>
              <li><a href="/#colaboradores" class="text-white hover:text-primary transition-colors">{t('colaboradores')}</a></li>
              <li><a href="/#nosotros" class="text-white hover:text-primary transition-colors">{t('nosotros')}</a></li>
              <li><a href="/#donaciones" class="text-white hover:text-primary transition-colors">{t('donaciones')}</a></li>
              <li><a href="/#contacto" class="text-white hover:text-primary transition-colors">{t('contacto')}</a></li>
              <li>
                <a href="https://wiki.luminakraft.com" target="_blank" class="text-white hover:text-primary transition-colors">
                  Wiki <i class="fas fa-external-link-alt text-xs ml-1"></i>
                </a>
              </li>
            </ul>
          </div>
          <div class="footer-section text-center">
            <h3 class="text-xl font-bold mb-4 text-primary relative pb-2 inline-block">{t('social-media')}</h3>
            <div class="flex justify-center space-x-4">
              <a href="https://x.com/luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="X (Twitter)">
                <i class="fab fa-x-twitter"></i>
              </a>
              <a href="https://instagram.com/luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="Instagram">
                <i class="fab fa-instagram"></i>
              </a>
              <a href="https://tiktok.com/@luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="TikTok">
                <i class="fab fa-tiktok"></i>
              </a>
              <a href="https://youtube.com/@luminakraft" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="YouTube">
                <i class="fab fa-youtube"></i>
              </a>
              <a href="https://discord.luminakraft.com" target="_blank" class="text-white hover:text-primary transition-colors text-2xl" aria-label="Discord">
                <i class="fab fa-discord"></i>
              </a>
            </div>
          </div>
          <div class="footer-section text-center">
            <h3 class="text-xl font-bold mb-4 text-primary relative pb-2 inline-block">{t('legal')}</h3>
            <ul class="space-y-2">
              <li><a href="/privacy" class="text-white hover:text-primary transition-colors">{t('privacy-policy')}</a></li>
              <li><a href="/terms" class="text-white hover:text-primary transition-colors">{t('terms-of-service')}</a></li>
            </ul>
          </div>
        </div>
        <div class="mt-12 text-center text-sm text-gray-400">
          <p>&copy; {new Date().getFullYear()} LuminaKraft Studios. {t('all-rights-reserved')}</p>
        </div>
      </div>
    </footer>

    <script define:vars={{ finalLocale }}>
      document.addEventListener('DOMContentLoaded', function() {
        setupMobileMenu();
        setupLanguageSelectors();
        updatePageUrl();
        setupHeaderScroll();

        function updatePageUrl() {
          // Obtener la URL actual
          let currentUrl = window.location.href;
          
          // Si la URL contiene /en/, actualizarla para eliminar ese prefijo
          if (currentUrl.includes('/en/')) {
            const newUrl = currentUrl.replace('/en/', '/');
            window.history.replaceState({}, document.title, newUrl);
          }
        }

        function setupHeaderScroll() {
          const header = document.querySelector('header');
          if (!header) return;
          
          window.onscroll = function() {
            if (window.scrollY > 50) {
              header?.classList.add('py-2', 'bg-secondary/95');
              header?.classList.remove('py-3', 'bg-secondary/70');
            } else {
              header?.classList.remove('py-2', 'bg-secondary/95');
              header?.classList.add('py-3', 'bg-secondary/70');
            }
          };
        }

        // Configuración de los selectores de idioma y manejo de cookies
        function setupLanguageSelectors() {
          // El valor finalLocale viene del servidor y se pasa a través de define:vars
          
          // Función para obtener el valor de una cookie específica
          function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
              cookie = cookie.trim();
              if (cookie.startsWith(name + '=')) {
                return cookie.substring(name.length + 1);
              }
            }
            return null;
          }
          
          // Obtener la cookie de idioma si existe
          const languageCookie = getCookie('selectedLanguage');
          
          // Función para cambiar el idioma
          function changeLanguage(lang) {
            
            // Guardar la cookie con expiración de 1 año
            const expirationDate = new Date();
            expirationDate.setFullYear(expirationDate.getFullYear() + 1);
            document.cookie = `selectedLanguage=${lang}; expires=${expirationDate.toUTCString()}; path=/; SameSite=Lax`;
            
            // Recargar la página para aplicar el nuevo idioma
            window.location.reload();
          }
          
          // Configurar el selector de idioma de la versión de escritorio
          const desktopSelector = document.querySelector('#language-selector');
          if (desktopSelector) {
            // Establecer el valor seleccionado basado en la cookie o el valor del servidor
            if (desktopSelector instanceof HTMLSelectElement) {
              desktopSelector.value = languageCookie || finalLocale;
            }
            
            desktopSelector.addEventListener('change', function(e) {
              const target = e.target;
              if (target instanceof HTMLSelectElement) {
                changeLanguage(target.value);
              }
            });
          }
          
          // Configurar el selector de idioma de la versión móvil
          const mobileSelector = document.querySelector('#mobile-language-selector');
          if (mobileSelector) {
            // Establecer el valor seleccionado basado en la cookie o el valor del servidor
            if (mobileSelector instanceof HTMLSelectElement) {
              mobileSelector.value = languageCookie || finalLocale;
            }
            
            mobileSelector.addEventListener('change', function(e) {
              const target = e.target;
              if (target instanceof HTMLSelectElement) {
                changeLanguage(target.value);
              }
            });
          }
        }
        
        // Configuración del menú móvil
        function setupMobileMenu() {
          const mobileMenuBtn = document.getElementById('mobileMenuBtn');
          const mobileMenu = document.getElementById('mobileMenu');
          
          if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', function() {
              mobileMenu.classList.toggle('translate-x-full');
              document.body.classList.toggle('overflow-hidden');
            });
          }
          
          const closeMenu = document.querySelector('.close-menu');
          if (closeMenu && mobileMenu) {
            closeMenu.addEventListener('click', function() {
              mobileMenu.classList.add('translate-x-full');
              document.body.classList.remove('overflow-hidden');
            });
          }
          
          // Cerrar el menú cuando se hace clic en cualquier enlace dentro del menú
          const mobileMenuLinks = mobileMenu?.querySelectorAll('a');
          if (mobileMenuLinks && mobileMenuLinks.length > 0) {
            mobileMenuLinks.forEach(link => {
              link.addEventListener('click', () => {
                mobileMenu.classList.add('translate-x-full');
                document.body.classList.remove('overflow-hidden');
              });
            });
          }
        }
      });
    </script>
  </body>
</html>